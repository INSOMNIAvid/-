<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TON Wallet | Ваш безопасный кошелек</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --ton-primary: #0088cc;
            --ton-primary-dark: #0066a3;
            --ton-secondary: #7dcfff;
            --ton-dark: #1a1a1a;
            --ton-light: #f5f7fa;
            --ton-success: #2bbc7d;
            --ton-warning: #ff9f0a;
            --ton-danger: #ff453a;
            --ton-gradient: linear-gradient(135deg, #0088cc 0%, #0066a3 100%);
            --ton-glass: rgba(255, 255, 255, 0.1);
            --ton-card-shadow: 0 8px 32px rgba(0, 136, 204, 0.15);
        }
        
        body {
            background: linear-gradient(135deg, #0f1c2d 0%, #1f3a5f 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            padding: 20px;
        }
        
        .wallet-container {
            max-width: 900px;
            margin: 20px auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .wallet-header {
            background: var(--ton-gradient);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .wallet-header::before {
            content: "";
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(30deg);
        }
        
        .ton-logo {
            width: 90px;
            height: 90px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2;
        }
        
        .ton-logo i {
            font-size: 45px;
            color: var(--ton-primary);
        }
        
        .wallet-body {
            padding: 30px;
        }
        
        .balance-card {
            background: var(--ton-gradient);
            color: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--ton-card-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .balance-card::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: var(--ton-glass);
            transform: rotate(32deg);
        }
        
        .balance-amount {
            font-size: 3rem;
            font-weight: 700;
            margin: 15px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .currency-card {
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .currency-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 136, 204, 0.2);
        }
        
        .currency-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
            background: var(--ton-primary);
            color: white;
            box-shadow: 0 4px 10px rgba(0, 136, 204, 0.3);
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn-action {
            padding: 18px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .btn-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-send:hover {
            background: var(--ton-primary);
        }
        
        .btn-receive:hover {
            background: var(--ton-success);
        }
        
        .btn-buy:hover {
            background: var(--ton-warning);
        }
        
        .btn-swap:hover {
            background: var(--ton-secondary);
            color: var(--ton-dark);
        }
        
        .transaction-list {
            margin-top: 30px;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            align-items: center;
            transition: background 0.3s;
        }
        
        .transaction-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-amount {
            font-weight: 600;
            text-align: right;
        }
        
        .status-connected {
            color: var(--ton-success);
            font-weight: 600;
        }
        
        .status-disconnected {
            color: var(--ton-danger);
            font-weight: 600;
        }
        
        .wallet-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #ton-connect {
            margin: 25px 0;
        }
        
        .network-badge {
            background: var(--ton-secondary);
            color: var(--ton-dark);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .qr-code {
            text-align: center;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-content {
            border-radius: 20px;
            background: #1e2b3d;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .form-control {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 12px;
            padding: 12px 15px;
        }
        
        .form-control:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--ton-primary);
            box-shadow: 0 0 0 0.2rem rgba(0, 136, 204, 0.25);
            color: white;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .price-change {
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .price-up {
            color: var(--ton-success);
        }
        
        .price-down {
            color: var(--ton-danger);
        }
        
        .btn-close {
            filter: invert(1);
        }
        
        @media (max-width: 768px) {
            .action-buttons {
                grid-template-columns: 1fr;
            }
            
            .balance-amount {
                font-size: 2.2rem;
            }
            
            .wallet-body {
                padding: 20px;
            }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="wallet-container">
            <div class="wallet-header">
                <div class="ton-logo">
                    <i class="fab fa-bitcoin"></i>
                </div>
                <h1>TON Wallet</h1>
                <p class="mb-0">Безопасное управление вашими TON активами</p>
            </div>
            
            <div class="wallet-body">
                <!-- Connection Status -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5>Статус подключения: 
                        <span id="connection-status" class="status-disconnected">Не подключено</span>
                    </h5>
                    <button id="disconnect-btn" class="btn btn-outline-danger btn-sm" disabled>
                        <i class="fas fa-unlink me-1"></i>Отключиться
                    </button>
                </div>
                
                <!-- TON Connect Button -->
                <div id="ton-connect"></div>
                
                <!-- Wallet Info -->
                <div id="wallet-info" class="wallet-info" style="display: none;">
                    <h4><i class="fas fa-wallet me-2"></i>Информация о кошельке</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Адрес:</strong> <span id="wallet-address"></span></p>
                            <p><strong>Сеть:</strong> <span id="wallet-chain" class="network-badge"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Устройство:</strong> <span id="wallet-device"></span></p>
                            <p><strong>Провайдер:</strong> <span id="wallet-provider"></span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Balance Card -->
                <div class="balance-card">
                    <p class="mb-1">Общий баланс</p>
                    <h2 class="balance-amount" id="ton-balance">
                        <span id="balance-loader" class="loading-spinner" style="display: none;"></span>
                        <span id="balance-value">0.00 TON</span>
                    </h2>
                    <p class="mb-0">$ <span id="usd-balance">0.00</span> USD 
                        <span id="ton-price-change" class="price-change"></span>
                    </p>
                    <p class="mb-0 mt-2 small">Курс TON: $<span id="ton-price">2.50</span></p>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-action btn-send" data-bs-toggle="modal" data-bs-target="#sendModal">
                        <i class="fas fa-paper-plane"></i>Отправить
                    </button>
                    <button class="btn btn-action btn-receive" data-bs-toggle="modal" data-bs-target="#receiveModal">
                        <i class="fas fa-download"></i>Получить
                    </button>
                    <button class="btn btn-action btn-buy" data-bs-toggle="modal" data-bs-target="#buyModal">
                        <i class="fas fa-shopping-cart"></i>Купить
                    </button>
                    <button class="btn btn-action btn-swap" data-bs-toggle="modal" data-bs-target="#swapModal">
                        <i class="fas fa-exchange-alt"></i>Обменять
                    </button>
                </div>
                
                <!-- Transactions -->
                <div class="transaction-list">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fas fa-history me-2"></i>Последние транзакции</h4>
                        <button id="refresh-transactions" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="glass-effect">
                        <div class="p-0">
                            <div id="transactions-container">
                                <div class="text-center py-4">
                                    <p class="text-muted">Загрузка транзакций...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>TON Wallet &copy; 2023 | Полная интеграция с TON Blockchain</p>
        </div>
    </div>

    <!-- Send Modal -->
    <div class="modal fade" id="sendModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-paper-plane me-2"></i>Отправить TON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="recipient-address" class="form-label">Адрес получателя</label>
                        <input type="text" class="form-control" id="recipient-address" placeholder="Введите TON адрес">
                    </div>
                    <div class="mb-3">
                        <label for="send-amount" class="form-label">Сумма (TON)</label>
                        <input type="number" class="form-control" id="send-amount" placeholder="0.00" step="0.01">
                        <div class="form-text">Доступно: <span id="available-balance">0.00</span> TON</div>
                    </div>
                    <div class="mb-3">
                        <label for="send-message" class="form-label">Сообщение (необязательно)</label>
                        <textarea class="form-control" id="send-message" rows="2" placeholder="Добавьте комментарий к транзакции"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="confirm-send">
                        <span id="send-loader" class="loading-spinner" style="display: none;"></span>
                        Отправить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receive Modal -->
    <div class="modal fade" id="receiveModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-download me-2"></i>Получить TON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="qr-code">
                        <canvas id="qr-canvas" width="200" height="200"></canvas>
                        <p class="mt-3">Отсканируйте QR-код для получения TON</p>
                    </div>
                    <div class="mt-3">
                        <p>Ваш TON адрес:</p>
                        <div class="input-group">
                            <input type="text" class="form-control" id="wallet-address-copy" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copy-address">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buy Modal -->
    <div class="modal fade" id="buyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-shopping-cart me-2"></i>Купить TON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Функция покупки TON будет доступна в ближайшем обновлении.</p>
                    <p class="small text-muted">Вы можете приобрести TON на официальных биржах и отправить их на ваш адрес.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Swap Modal -->
    <div class="modal fade" id="swapModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Обменять TON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Функция обмена будет доступна в ближайшем обновлении.</p>
                    <p class="small text-muted">Мы работаем над интеграцией с децентрализованными биржами TON.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
    
    <script>
        // Initialize TON Connect with correct manifest
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://insomniavid.github.io/-/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });
        
        // DOM Elements
        const connectionStatus = document.getElementById('connection-status');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const walletInfo = document.getElementById('wallet-info');
        const walletAddress = document.getElementById('wallet-address');
        const walletChain = document.getElementById('wallet-chain');
        const walletDevice = document.getElementById('wallet-device');
        const walletProvider = document.getElementById('wallet-provider');
        const balanceValue = document.getElementById('balance-value');
        const balanceLoader = document.getElementById('balance-loader');
        const usdBalance = document.getElementById('usd-balance');
        const tonPrice = document.getElementById('ton-price');
        const tonPriceChange = document.getElementById('ton-price-change');
        const transactionsContainer = document.getElementById('transactions-container');
        const confirmSendBtn = document.getElementById('confirm-send');
        const sendLoader = document.getElementById('send-loader');
        const copyAddressBtn = document.getElementById('copy-address');
        const walletAddressCopy = document.getElementById('wallet-address-copy');
        const availableBalance = document.getElementById('available-balance');
        const refreshTransactions = document.getElementById('refresh-transactions');
        
        // Check connection status on load
        tonConnectUI.connectionRestored.then(() => {
            updateStatus('Подключено', 'status-connected');
            disconnectBtn.disabled = false;
        });
        
        // Handle wallet status changes
        tonConnectUI.onStatusChange(async wallet => {
            if (wallet) {
                // Wallet connected
                updateStatus('Подключено', 'status-connected');
                disconnectBtn.disabled = false;
                
                // Update wallet information
                walletAddress.textContent = shortenAddress(wallet.account.address);
                walletChain.textContent = wallet.account.chain;
                walletDevice.textContent = wallet.device.appName || 'Неизвестно';
                walletProvider.textContent = wallet.provider?.appName || 'Неизвестно';
                
                // Show wallet info
                walletInfo.style.display = 'block';
                
                // Load wallet data
                await loadWalletData(wallet.account.address);
                
                // Generate QR code for receiving
                generateQRCode(wallet.account.address);
                walletAddressCopy.value = wallet.account.address;
            } else {
                // Wallet disconnected
                updateStatus('Не подключено', 'status-disconnected');
                disconnectBtn.disabled = true;
                walletInfo.style.display = 'none';
            }
        });
        
        // Handle disconnect button
        disconnectBtn.addEventListener('click', async () => {
            await tonConnectUI.disconnect();
            updateStatus('Не подключено', 'status-disconnected');
            disconnectBtn.disabled = true;
            walletInfo.style.display = 'none';
        });
        
        // Handle send confirmation
        confirmSendBtn.addEventListener('click', async () => {
            const recipient = document.getElementById('recipient-address').value;
            const amount = document.getElementById('send-amount').value;
            const message = document.getElementById('send-message').value;
            
            if (!recipient || !amount) {
                alert('Пожалуйста, введите адрес получателя и сумму');
                return;
            }
            
            if (parseFloat(amount) <= 0) {
                alert('Сумма должна быть больше 0');
                return;
            }
            
            try {
                sendLoader.style.display = 'inline-block';
                confirmSendBtn.disabled = true;
                
                const transaction = {
                    validUntil: Math.floor(Date.now() / 1000) + 360, // 6 minutes
                    messages: [
                        {
                            address: recipient,
                            amount: (parseFloat(amount) * 1000000000).toString(), // Convert to nanotons
                            payload: message ? stringToBytes(message) : undefined
                        }
                    ]
                };
                
                const result = await tonConnectUI.sendTransaction(transaction);
                alert(`Транзакция отправлена: ${result.boc}`);
                
                // Close modal
                const sendModal = bootstrap.Modal.getInstance(document.getElementById('sendModal'));
                sendModal.hide();
                
                // Reload wallet data
                const wallet = tonConnectUI.wallet;
                if (wallet) {
                    await loadWalletData(wallet.account.address);
                }
            } catch (error) {
                console.error('Transaction error:', error);
                alert(`Ошибка транзакции: ${error.message}`);
            } finally {
                sendLoader.style.display = 'none';
                confirmSendBtn.disabled = false;
            }
        });
        
        // Handle copy address
        copyAddressBtn.addEventListener('click', () => {
            walletAddressCopy.select();
            document.execCommand('copy');
            alert('Адрес скопирован в буфер обмена!');
        });
        
        // Handle refresh transactions
        refreshTransactions.addEventListener('click', () => {
            const wallet = tonConnectUI.wallet;
            if (wallet) {
                loadWalletData(wallet.account.address);
            }
        });
        
        // Update available balance when amount changes
        document.getElementById('send-amount').addEventListener('input', function() {
            const amount = parseFloat(this.value);
            const available = parseFloat(availableBalance.textContent);
            
            if (amount > available) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
        
        // Update status function
        function updateStatus(text, className) {
            connectionStatus.textContent = text;
            connectionStatus.className = className;
        }
        
        // Shorten address for display
        function shortenAddress(address, chars = 6) {
            if (!address) return '';
            return `${address.substring(0, chars)}...${address.substring(address.length - chars)}`;
        }
        
        // Load wallet data from TON API
        async function loadWalletData(address) {
            try {
                balanceLoader.style.display = 'inline-block';
                balanceValue.style.display = 'none';
                
                // Get balance
                const balanceResponse = await fetch(`https://tonapi.io/v2/accounts/${address}`);
                const balanceData = await balanceResponse.json();
                
                if (balanceData.balance) {
                    const balanceTon = (balanceData.balance / 1000000000).toFixed(2);
                    balanceValue.textContent = `${balanceTon} TON`;
                    availableBalance.textContent = balanceTon;
                    
                    // Get TON to USD rate
                    const tonPriceValue = parseFloat(tonPrice.textContent);
                    const usdValue = (balanceTon * tonPriceValue).toFixed(2);
                    usdBalance.textContent = usdValue;
                }
                
                // Get transactions
                const transactionsResponse = await fetch(`https://tonapi.io/v2/accounts/${address}/events?limit=5`);
                const transactionsData = await transactionsResponse.json();
                
                if (transactionsData.events && transactionsData.events.length > 0) {
                    displayTransactions(transactionsData.events, address);
                } else {
                    transactionsContainer.innerHTML = `
                        <div class="text-center py-4">
                            <p class="text-muted">Транзакции не найдены</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading wallet data:', error);
                transactionsContainer.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-danger">Ошибка загрузки данных</p>
                    </div>
                `;
            } finally {
                balanceLoader.style.display = 'none';
                balanceValue.style.display = 'inline';
            }
        }
        
        // Load TON price from API
        async function loadTonPrice() {
            try {
                // Using CoinGecko API to get TON price
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd&include_24hr_change=true');
                const data = await response.json();
                
                if (data['the-open-network']) {
                    const price = data['the-open-network'].usd;
                    const change = data['the-open-network'].usd_24h_change;
                    
                    tonPrice.textContent = price.toFixed(2);
                    tonPriceChange.textContent = `${change.toFixed(2)}%`;
                    tonPriceChange.classList.add(change >= 0 ? 'price-up' : 'price-down');
                    
                    // Update USD balance if we have TON balance
                    const tonBalanceValue = parseFloat(balanceValue.textContent);
                    if (tonBalanceValue > 0) {
                        usdBalance.textContent = (tonBalanceValue * price).toFixed(2);
                    }
                }
            } catch (error) {
                console.error('Error loading TON price:', error);
                // Fallback price
                tonPrice.textContent = '2.50';
            }
        }
        
        // Display transactions
        function displayTransactions(events, address) {
            let transactionsHTML = '';
            
            events.forEach(event => {
                if (!event.actions) return;
                
                event.actions.forEach(action => {
                    if (action.type === 'TonTransfer') {
                        const isIncoming = action.tonTransfer.recipient.address === address;
                        const amount = (action.tonTransfer.amount / 1000000000).toFixed(2);
                        const otherParty = isIncoming 
                            ? shortenAddress(action.tonTransfer.sender.address) 
                            : shortenAddress(action.tonTransfer.recipient.address);
                        
                        const timestamp = new Date(event.timestamp * 1000).toLocaleDateString('ru-RU');
                        
                        transactionsHTML += `
                            <div class="transaction-item">
                                <div class="d-flex align-items-center">
                                    <div class="transaction-icon">
                                        <i class="fas ${isIncoming ? 'fa-arrow-down text-success' : 'fa-arrow-up text-danger'}"></i>
                                    </div>
                                    <div class="transaction-details">
                                        <div class="fw-bold">${isIncoming ? 'Получено' : 'Отправлено'} TON</div>
                                        <div class="text-muted small">${otherParty} • ${timestamp}</div>
                                    </div>
                                </div>
                                <div class="transaction-amount ${isIncoming ? 'text-success' : 'text-danger'}">
                                    ${isIncoming ? '+' : '-'}${amount} TON
                                </div>
                            </div>
                        `;
                    }
                });
            });
            
            transactionsContainer.innerHTML = transactionsHTML || `
                <div class="text-center py-4">
                    <p class="text-muted">Транзакции не найдены</p>
                </div>
            `;
        }
        
        // Generate QR code
        function generateQRCode(address) {
            const canvas = document.getElementById('qr-canvas');
            QRCode.toCanvas(canvas, address, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#0088cc',
                    light: '#ffffff'
                }
            }, function(error) {
                if (error) console.error('QR code error:', error);
            });
        }
        
        // Helper function to convert string to bytes for payload
        function stringToBytes(str) {
            return Array.from(str).map(c => c.charCodeAt(0));
        }
        
        // Load initial data
        loadTonPrice();
    </script>
</body>
</html>
